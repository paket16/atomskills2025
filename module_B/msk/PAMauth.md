# Настройка ограничения времени доступа для MSK-WORKER

## 1. Настройка временных ограничений с помощью PAM

Создадим скрипт для проверки времени доступа:

```bash
sudo nano /usr/local/bin/check_access_time.sh
```

Добавим содержимое:
```bash
#!/bin/bash

# Разрешенные часы работы (9:00-18:00 по Москве)
ALLOW_START=9
ALLOW_END=18

# Текущее время по Москве
current_hour=$(TZ='Europe/Moscow' date +%H)

# Проверка времени
if [ "$current_hour" -ge "$ALLOW_START" ] && [ "$current_hour" -lt "$ALLOW_END" ]; then
    exit 0  # Разрешить доступ
else
    # Проверяем, является ли пользователь administrator
    if [ "$PAM_USER" = "administrator" ]; then
        exit 0  # Разрешить доступ администратору
    else
        echo "Доступ разрешен только с 09:00 до 18:00 по МСК. Для получения доступа вне этого времени свяжитесь с администратором." > /etc/issue
        exit 1  # Запретить доступ
    fi
fi
```

Сделаем скрипт исполняемым:
```bash
sudo chmod +x /usr/local/bin/check_access_time.sh
```

## 2. Настройка PAM для проверки времени доступа

Добавим проверку в файл `/etc/pam.d/login`:
```bash
sudo nano /etc/pam.d/login
```

Добавим строку перед другими правилами аутентификации:
```
auth required pam_exec.so /usr/local/bin/check_access_time.sh
```

## 3. Настройка сообщения на экране блокировки

Создадим файл с сообщением:
```bash
sudo nano /etc/issue
```

Добавим содержимое:
```
В случае необходимости доступа к рабочему месту вне регламентированных работ (09:00-18:00 по МСК),
напишите на почту - admin@company.cool
```

Для обновления сообщения при каждом входе добавим в `/etc/bashrc`:
```bash
echo "В случае необходимости доступа к рабочему месту вне регламентированных работ (09:00-18:00 по МСК), напишите на почту - admin@company.cool" > /etc/issue
```


## Дополнительные меры (опционально)

Для более надежной защиты можно добавить в cron задачу, которая будет завершать все сессии в 18:00 (кроме администратора):
```bash
sudo crontab -e
```

Добавить строку:
```
0 18 * * * for user in $(who | grep -v 'administrator' | awk '{print $1}' | uniq); do pkill -KILL -u $user; done
```

Эта команда будет принудительно завершать все сессии (кроме администратора) в 18:00 по системному времени.